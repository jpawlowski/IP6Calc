#!/bin/sh

cl=debian/changelog

test -x "`which git`" || {
	echo 'Warning: cannot find git - do you have package git installed?' 2>&1
	test -f $cl && {
		echo cannot find svn, but $cl exists - accepting it
	} || {
		echo 'Error: cannot find git and' $cl 'does not exist - cannot proceed.' 1>&2
		exit 1
	}
}
test -d .git || {
	echo 'Warning: this is not a GIT checkout, building in non-dev mode...' 2>&1
	test -f $cl && {
		echo 'Info:' $cl 'does exist, accepting it for now'
	} || {
		echo 'Error:' $cl 'does not exist, cannot proceed.' 2>&1
		exit 1
	}
}

echo Generating $cl ...

REV=`git log -1 --date=short --pretty=format:%ad-%h`

if test `git status --short -uno |wc -l` -gt 0 ; then
 REV="$REV-modified1"
fi

echo "ip6calc ($REV) unstable; urgency=low" >$cl
echo >>$cl
echo "  Package Generated by" `whoami`@`hostname -f` `date -R`>>$cl
echo >>$cl
test -x "`which git2cl`" && {
	git2cl | sed 's/^/  /' | sed 's/\t/   /' >>$cl
} || {
	echo 'Warning: cannot find git2cl - do you have it installed?' 2>&1
	echo 'Warning:' $cl 'will have an empty body, this may not be what you wanted.' 2>&1
	echo ' ' `date +%Y-%m-%d` `whoami` >>$cl
	echo '    * built package without git log info available, sorry.' >>$cl
}
echo >>$cl
echo -n ' -- Konrad Rosenbaum <konrad@silmor.de>  ' >>$cl
date -R >>$cl
